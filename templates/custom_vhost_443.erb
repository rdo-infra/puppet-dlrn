<VirtualHost *:443>
  ServerName default

  ## Vhost docroot
  DocumentRoot "/var/www/html"

  ## Directories, there should at least be a declaration for /var/www/html

  <Directory "/var/www/html">
    Options Indexes FollowSymLinks MultiViews
    AllowOverride FileInfo
    AddType text/plain yaml yml
    Require all granted
  </Directory>

<% if @api_workers %> <% @api_workers.each do |worker| -%>
  # WSGI configuration for worker <%= worker %>
  # NOTE(dpawlik): use python-path param instead of python-home,
  # if python version required to compile mod_wsgi was different.
  WSGIDaemonProcess ssl-dlrn-<%= worker -%> python-home=/home/<%= worker %>/.venv group=<%= worker -%> processes=5 threads=1 user=<%= worker %>
  WSGIScriptAlias /api-<%= worker -%> "/home/<%= worker -%>/api/dlrn-api-<%= worker -%>.wsgi"
  <% if worker.start_with?('rhel8') -%>WSGIScriptAlias /api-<%= worker.gsub('rhel8', 'redhat') -%> "/home/<%= worker -%>/api/dlrn-api-<%= worker -%>.wsgi"<% end -%>

  <Location "/api-<%= worker -%>">
    Require all granted
    SetEnv CONFIG_FILE /home/<%= worker -%>/api/dlrn-api-<%= worker -%>.cfg
    WSGIProcessGroup ssl-dlrn-<%= worker %>
    WSGIPassAuthorization On
  </Location>

  <% if worker.start_with?('rhel8') %>
  <Location "/api-<%= worker.gsub('rhel8', 'redhat') -%>">
    Require all granted
    SetEnv CONFIG_FILE /home/<%= worker -%>/api/dlrn-api-<%= worker -%>.cfg
    WSGIProcessGroup ssl-dlrn-<%= worker %>
    WSGIPassAuthorization On
  </Location><% end %>

<% end -%> <% end %>

  ## Logging
  ErrorLog "/var/log/httpd/ssl-<%= @web_domain %>_error_ssl.log"
  ServerSignature Off
  CustomLog "/var/log/httpd/ssl-<%= @web_domain %>_access_ssl.log" combined

  ## SSL directives
  SSLEngine on
  SSLCertificateFile      "/etc/letsencrypt/live/<%= @web_domain %>/cert.pem"
  SSLCertificateKeyFile   "/etc/letsencrypt/live/<%= @web_domain %>/privkey.pem"
  SSLCertificateChainFile "/etc/letsencrypt/live/<%= @web_domain %>/fullchain.pem"
  SSLCACertificatePath    "/etc/pki/tls/certs"
  SSLProtocol             ALL -SSLv2 -SSLv3
  SSLHonorCipherOrder     on
</VirtualHost>

